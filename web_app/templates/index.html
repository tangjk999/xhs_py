<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红书热门博客分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff2442;
            --secondary-color: #ff6b81;
            --accent-color: #ff8fa3;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin: 2rem auto;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .btn {
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 36, 66, 0.4);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 36, 66, 0.25);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .result-section {
            display: none;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            background: #e9ecef;
            margin: 1rem 0;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
        }
        
        .tab-content {
            padding: 1rem 0;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px 15px 0 0;
            margin-right: 0.5rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1rem;
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        /* 博客列表样式 */
        .blog-list-item {
            border: none;
            border-bottom: 1px solid #e9ecef;
            border-radius: 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .blog-list-item:hover {
            background: linear-gradient(135deg, rgba(255, 36, 66, 0.1), rgba(255, 107, 129, 0.1));
            transform: translateX(5px);
        }
        
        .blog-list-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-left: 4px solid white;
        }
        
        .blog-list-item .blog-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .blog-list-item .blog-meta {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .blog-list-item .blog-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .blog-list-item .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* 博客详情样式 */
        .blog-detail-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        
        .blog-detail-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--dark-color);
        }
        
        .blog-detail-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .blog-detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .blog-detail-content {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .blog-detail-section {
            margin-bottom: 2rem;
        }
        
        .blog-detail-section h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .blog-list-item {
                padding: 1rem;
            }
            
            .blog-detail-header {
                padding: 1rem;
            }
            
            .blog-detail-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                小红书分析系统
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container">
        <div class="main-container">
            <!-- 系统状态 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="metric-card">
                        <div class="metric-value" id="total-notes">0</div>
                        <div class="metric-label">总笔记数</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card">
                        <div class="metric-value" id="avg-likes">0</div>
                        <div class="metric-label">平均点赞</div>
                    </div>
                </div>
            </div>

            <!-- 功能标签页 -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="crawl-tab" data-bs-toggle="tab" data-bs-target="#crawl" type="button" role="tab">
                        <i class="fas fa-spider me-2"></i>智能爬取
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analyze-tab" data-bs-toggle="tab" data-bs-target="#analyze" type="button" role="tab">
                        <i class="fas fa-brain me-2"></i>AI分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="visualize-tab" data-bs-toggle="tab" data-bs-target="#visualize" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>可视化
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>设置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
                        <i class="fas fa-info-circle me-2"></i>关于
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabsContent">
                <!-- 爬取标签页 -->
                <div class="tab-pane fade show active" id="crawl" role="tabpanel">
                    <!-- 爬取设置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-spider me-2"></i>
                            智能爬取设置
                        </div>
                        <div class="card-body">
                            <form id="crawlForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="topic" class="form-label">搜索主题</label>
                                            <input type="text" class="form-control" id="topic" name="topic" 
                                                   placeholder="例如：美食、旅行、美妆..." required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="limit" class="form-label">获取数量</label>
                                            <select class="form-control" id="limit" name="limit">
                                                <option value="10">10条</option>
                                                <option value="20" selected>20条</option>
                                                <option value="50">50条</option>
                                                <option value="100">100条</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- 隐藏的Cookie字段 -->
                                <input type="hidden" id="cookies" name="cookies">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play me-2"></i>开始爬取
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- 爬取进度 -->
                    <div class="loading" id="crawlLoading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">爬取中...</span>
                        </div>
                        <p class="mt-3">正在爬取数据，请稍候...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 数据展示区域 -->
                    <div class="result-section" id="crawlResult" style="display: none;">
                        <div class="row">
                            <!-- 左侧：博客列表 -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-list me-2"></i>
                                        博客列表
                                        <span class="badge bg-primary ms-2" id="blogCount">0</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush" id="blogList">
                                            <!-- 博客列表项将在这里动态生成 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧：详细分析 -->
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i>
                                        详细分析
                                        <span class="text-muted ms-2" id="selectedBlogTitle">请选择左侧博客查看详情</span>
                                    </div>
                                    <div class="card-body">
                                        <div id="blogDetail">
                                            <div class="text-center text-muted py-5">
                                                <i class="fas fa-hand-pointer fa-3x mb-3"></i>
                                                <p>点击左侧博客查看详细分析</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分析标签页 -->
                <div class="tab-pane fade" id="analyze" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                                <i class="fas fa-brain me-2"></i>
                            AI深度分析
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                            <div class="mb-3">
                                        <label for="analysisFile" class="form-label">选择数据文件</label>
                                        <select class="form-control" id="analysisFile" name="analysisFile">
                                            <option value="">请先爬取数据...</option>
                                </select>
                            </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="analysisType" class="form-label">分析类型</label>
                                        <select class="form-control" id="analysisType" name="analysisType">
                                            <option value="comprehensive">综合分析</option>
                                            <option value="trends">趋势分析</option>
                                            <option value="ai">AI深度分析</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" id="analyzeBtn">
                                <i class="fas fa-magic me-2"></i>开始分析
                            </button>
                            </div>
                        </div>

                    <!-- 分析进度 -->
                    <div class="loading" id="analyzeLoading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">分析中...</span>
                    </div>
                        <p class="mt-3">正在进行AI分析，请稍候...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- 分析结果 -->
                    <div class="result-section" id="analyzeResult">
                <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                            <i class="fas fa-chart-pie me-2"></i>
                            分析结果
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="exportAnalysis">
                                        <i class="fas fa-download me-1"></i>导出
                                    </button>
                                </div>
                    </div>
                    <div class="card-body">
                                <div id="analysisContent"></div>
                                </div>
                            </div>
                                </div>
                            </div>

                <!-- 可视化标签页 -->
                <div class="tab-pane fade" id="visualize" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-chart-bar me-2"></i>
                                数据可视化
                                </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="downloadCharts">
                                    <i class="fas fa-image me-1"></i>下载
                                </button>
                            </div>
                                </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="authorChart"></canvas>
                            </div>
                        </div>
                                <div class="col-md-6">
                                    <div class="chart-container">
                                        <canvas id="likesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        <div class="row">
                                <div class="col-md-12">
                                    <div class="chart-container">
                                        <canvas id="trendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设置标签页 -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                            <i class="fas fa-cog me-2"></i>
                            系统设置
                                    </div>
                                    <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="apiKey" class="form-label">DeepSeek API密钥</label>
                                        <input type="password" class="form-control" id="apiKey" name="apiKey" 
                                               placeholder="输入你的DeepSeek API密钥">
                                        <div class="form-text">用于AI分析功能，不填则使用模拟分析</div>
                                        </div>
                                    <button type="button" class="btn btn-primary" id="saveApiKey">
                                        <i class="fas fa-save me-2"></i>保存API密钥
                                    </button>
                                    </div>
                                <!-- Cookie转换器 -->
                                <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                            <i class="fas fa-exchange-alt me-2"></i>
                                            Cookie转换与保存
                                    </div>
                                    <div class="card-body">
                                            <!-- Cookie状态显示 -->
                                            <div class="mb-3">
                                                <label class="form-label">Cookie状态</label>
                                                <div class="d-flex align-items-center mb-2">
                                                    <div id="cookieStatus" class="badge bg-secondary me-2">检查中...</div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="checkCookieStatus">
                                                        <i class="fas fa-sync-alt"></i>检查
                                                    </button>
                                                </div>
                                                <small class="text-muted" id="cookieStatusMessage">正在检查Cookie有效性...</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="rawCookies" class="form-label">原始Cookie格式</label>
                                                <textarea class="form-control" id="rawCookies" name="rawCookies" rows="3" 
                                                          placeholder="粘贴从浏览器复制的cookie格式..."></textarea>
                                        </div>
                                            <div class="d-flex">
                                                <button type="button" class="btn btn-info me-2" id="convertCookies">
                                                    <i class="fas fa-magic me-2"></i>转换
                                                </button>
                                                <button type="button" class="btn btn-success" id="saveCookies">
                                                    <i class="fas fa-save me-2"></i>保存Cookies
                                                </button>
                                            </div>
                                            <div class="mt-3" id="convertedCookies" style="display: none;">
                                                <label class="form-label">转换结果</label>
                                                <textarea class="form-control" id="jsonCookies" name="jsonCookies" rows="3" readonly></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <!-- 文件管理 -->
                    <div class="card">
                            <div class="card-header">
                            <i class="fas fa-folder me-2"></i>
                            文件管理
                            </div>
                            <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>数据文件</h6>
                                    <div class="file-list" id="dataFiles"></div>
                                </div>
                                <div class="col-md-6">
                                    <h6>分析文件</h6>
                                    <div class="file-list" id="analysisFiles"></div>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>

                <!-- 关于标签页 -->
                <div class="tab-pane fade" id="about" role="tabpanel">
                    <div class="card">
                            <div class="card-header">
                            <i class="fas fa-info-circle me-2"></i>
                            关于项目
                            </div>
                            <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5>小红书分析系统</h5>
                                    <p class="text-muted">基于Python的小红书数据爬取与AI分析系统</p>
                                    
                                    <h6>主要功能</h6>
                                    <ul>
                                        <li>🕷️ 智能爬取：从小红书爬取指定主题的热门博客数据</li>
                                        <li>🤖 AI分析：利用DeepSeek大模型进行深度分析</li>
                                        <li>📊 可视化展示：现代化界面展示分析结果</li>
                                        <li>🔧 数据导出：支持多种格式导出</li>
                                    </ul>
                                    
                                    <h6>技术栈</h6>
                                    <p>Python + Flask + Selenium + DeepSeek API + Bootstrap</p>
                                    
                                    <h6>部署方式</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <a href="https://app.netlify.com/start/deploy?repository=https://github.com/your-repo/xhs_py" target="_blank" class="btn btn-sm btn-primary">
                                                <img src="https://www.netlify.com/img/deploy/button.svg" alt="Deploy to Netlify">
                                            </a>
                            </div>
                                        <div class="col-md-6">
                                            <code>docker run -p 8080:8080 xhs-analyzer</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6>项目信息</h6>
                                            <p><strong>版本：</strong>1.0.0</p>
                                            <p><strong>许可证：</strong>MIT</p>
                                            <hr>
                                            <a href="#" class="btn btn-sm btn-outline-primary" onclick="switchToTab('crawl')">开始使用</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮动操作按钮 -->
    <button class="floating-action-btn" id="scrollToTop" title="回到顶部">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast弹窗容器 -->
    <div id="toastContainer" style="position: fixed; left: 50%; bottom: 40px; transform: translateX(-50%); z-index: 9999; min-width: 320px; max-width: 90vw; pointer-events: none;"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        // 全局变量
        let currentData = null;
        let charts = {};
        let tableState = { page: 1, pageSize: 20, search: '' };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadSettings();
            loadFiles();
            initializeCharts();
            
            // 绑定事件
            bindEvents();
            
            // 自动检查Cookie状态
            setTimeout(checkCookieStatus, 1000);
        });

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }

        // 绑定事件
        function bindEvents() {
            // 爬取表单提交
            document.getElementById('crawlForm').addEventListener('submit', handleCrawl);
            
            // 分析按钮
            document.getElementById('analyzeBtn').addEventListener('click', handleAnalyze);
            
            // 设置保存
            document.getElementById('saveApiKey').addEventListener('click', saveApiKey);
            document.getElementById('saveCookies').addEventListener('click', saveCookies);
            
            // Cookie转换
            document.getElementById('convertCookies').addEventListener('click', convertCookies);
            
            // 检查Cookie状态
            document.getElementById('checkCookieStatus').addEventListener('click', checkCookieStatus);
            
            // 回到顶部
            document.getElementById('scrollToTop').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // 表格搜索和分页功能（如果存在对应元素）
            const tableSearch = document.getElementById('tableSearch');
            if (tableSearch) {
                tableSearch.addEventListener('input', function(e) {
                    tableState.search = e.target.value.trim();
                    tableState.page = 1;
                    renderCrawlTable();
                });
            }
            
            const tablePageSize = document.getElementById('tablePageSize');
            if (tablePageSize) {
                tablePageSize.addEventListener('change', function(e) {
                    tableState.pageSize = parseInt(e.target.value);
                    tableState.page = 1;
                    renderCrawlTable();
                });
            }
            
            // 导出功能（如果存在对应元素）
            const exportCsv = document.getElementById('exportCsv');
            if (exportCsv) {
                exportCsv.addEventListener('click', exportTableToCsv);
            }
            
            document.getElementById('exportAnalysis').addEventListener('click', exportAnalysisToJson);
            
            document.getElementById('downloadCharts').addEventListener('click', downloadCharts);

            document.getElementById('cookies').addEventListener('input', function(e) {
                const val = e.target.value.trim();
                if (val.startsWith('{')) {
                    e.target.value = '';
                    showError('格式错误', '请粘贴浏览器复制的原始cookie（多字段、tab分隔），不要粘贴JSON格式！');
                }
            });
        }

        // 处理爬取
        async function handleCrawl(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                topic: formData.get('topic'),
                limit: parseInt(formData.get('limit')),
                cookies: formData.get('cookies')
            };
            
            showLoading('crawlLoading');
            hideResult('crawlResult');
            
            try {
                const response = await fetch('/api/crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('爬取成功！', result.message);
                    currentData = result.data;
                    updateMetrics(result.data);
                    displayCrawlData(result.data); // 显示爬取数据
                    loadFiles(); // 重新加载文件列表
                } else {
                    showError('爬取失败', result.error);
                }
            } catch (error) {
                showError('网络错误', error.message);
            } finally {
                hideLoading('crawlLoading');
                showResult('crawlResult');
            }
        }

        // 处理分析
        async function handleAnalyze() {
            const file = document.getElementById('analysisFile').value;
            const type = document.getElementById('analysisType').value;
            
            if (!file) {
                showError('请选择数据文件', '请先爬取数据或选择已有文件');
                return;
            }
            
            showLoading('analyzeLoading');
            hideResult('analyzeResult');
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file: file,
                        type: type
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('分析成功！', 'AI分析已完成');
                    displayAnalysisResult(result.data);
                    updateCharts(result.data);
                } else {
                    showError('分析失败', result.error);
                }
            } catch (error) {
                showError('网络错误', error.message);
            } finally {
                hideLoading('analyzeLoading');
                showResult('analyzeResult');
            }
        }

        // 保存API密钥
        async function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            
            try {
                const response = await fetch('/api/save-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('保存成功', result.message);
                } else {
                    showError('保存失败', result.error);
                }
            } catch (error) {
                showError('网络错误', error.message);
            }
        }

        // 保存Cookies
        async function saveCookies() {
            // 优先取转换结果，否则取原始输入
            let cookies = document.getElementById('jsonCookies').value.trim();
            if (!cookies) {
                cookies = document.getElementById('rawCookies').value.trim();
            }
            // 校验JSON格式
            try {
                if (cookies) {
                    JSON.parse(cookies);
                }
            } catch (e) {
                showError('保存失败', 'Cookies不是有效的JSON格式，请使用转换器转换后再保存');
                return;
            }
            try {
                const response = await fetch('/api/save-cookies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cookies: cookies })
                });
                const result = await response.json();
                if (result.success) {
                    showSuccess('保存成功', result.message);
                    // 自动刷新爬取表单内容
                    document.getElementById('cookies').value = cookies;
                } else {
                    showError('保存失败', result.error);
                }
            } catch (error) {
                showError('网络错误', error.message);
            }
        }

        // 转换Cookies格式
        function convertCookies() {
            const rawCookies = document.getElementById('rawCookies').value.trim();
            if (!rawCookies) {
                showError('请输入Cookie数据', '请粘贴从浏览器复制的Cookie格式');
                return;
            }

            try {
                const lines = rawCookies.split('\n').filter(line => line.trim());
                const cookieObj = {};

                lines.forEach(line => {
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        const name = parts[0].trim();
                        const value = parts[1].trim();
                        
                        // 过滤掉空值和非cookie字段
                        if (name && value && !name.startsWith('__') && !name.includes('RequestId')) {
                            cookieObj[name] = value;
                        }
                    }
                });

                const jsonCookies = JSON.stringify(cookieObj, null, 2);
                document.getElementById('jsonCookies').value = jsonCookies;
                document.getElementById('convertedCookies').style.display = 'block';
                
                showSuccess('转换成功', `成功转换了 ${Object.keys(cookieObj).length} 个Cookie`);
            } catch (error) {
                showError('转换失败', 'Cookie格式不正确，请检查输入');
            }
        }

        // 使用转换后的Cookies
        function useConvertedCookies() {
            const jsonCookies = document.getElementById('jsonCookies').value;
            if (jsonCookies) {
                document.getElementById('cookies').value = jsonCookies;
                showSuccess('已应用', '转换后的Cookies已应用到爬取表单');
            }
        }

        // 清空Cookies
        function clearCookies() {
            document.getElementById('cookies').value = '';
            showSuccess('已清空', 'Cookie输入框已清空');
        }

        // 检查Cookie状态
        async function checkCookieStatus() {
            const statusBadge = document.getElementById('cookieStatus');
            const statusMessage = document.getElementById('cookieStatusMessage');
            const checkButton = document.getElementById('checkCookieStatus');
            
            // 更新状态为检查中
            statusBadge.className = 'badge bg-secondary me-2';
            statusBadge.textContent = '检查中...';
            statusMessage.textContent = '正在检查Cookie有效性...';
            checkButton.disabled = true;
            
            try {
                const response = await fetch('/api/cookie-status');
                const result = await response.json();
                
                if (result.valid) {
                    statusBadge.className = 'badge bg-success me-2';
                    statusBadge.textContent = '有效';
                    statusMessage.textContent = `Cookie有效，最后检查时间：${result.last_check || '未知'}`;
                } else {
                    statusBadge.className = 'badge bg-danger me-2';
                    statusBadge.textContent = '无效';
                    statusMessage.textContent = result.message || 'Cookie无效，请更新';
                }
            } catch (error) {
                statusBadge.className = 'badge bg-warning me-2';
                statusBadge.textContent = '检查失败';
                statusMessage.textContent = '无法连接到服务器检查Cookie状态';
            } finally {
                checkButton.disabled = false;
            }
        }

        // 加载设置
        async function loadSettings() {
            try {
                // 加载API密钥
                const apiResponse = await fetch('/api/load-api-key');
                const apiResult = await apiResponse.json();
                if (apiResult.success) {
                    document.getElementById('apiKey').value = apiResult.api_key;
                }
                // 加载Cookies
                const cookiesResponse = await fetch('/api/load-cookies');
                const cookiesResult = await cookiesResponse.json();
                if (cookiesResult.success) {
                    // 自动填充到爬取表单
                    document.getElementById('cookies').value = cookiesResult.cookies;
                }
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }

        // 加载文件列表
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const result = await response.json();
                
                if (result.success) {
                    updateFileList('dataFiles', result.data_files);
                    updateFileList('analysisFiles', result.analysis_files);
                    
                    // 更新分析文件选择器
                    const analysisFileSelect = document.getElementById('analysisFile');
                    analysisFileSelect.innerHTML = '<option value="">选择数据文件...</option>';
                    result.data_files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file;
                        analysisFileSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
            }
        }

        // 更新文件列表
        function updateFileList(containerId, files) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无文件</p>';
                return;
            }
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file me-2"></i>${file}</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadFile('${file}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
                container.appendChild(fileItem);
            });
        }

        // 下载文件
        function downloadFile(filename) {
            window.open(`/api/download/${filename}`, '_blank');
        }

        // 显示加载状态
        function showLoading(loadingId) {
            document.getElementById(loadingId).style.display = 'block';
        }

        // 隐藏加载状态
        function hideLoading(loadingId) {
            document.getElementById(loadingId).style.display = 'none';
        }

        // 显示结果
        function showResult(resultId) {
            document.getElementById(resultId).style.display = 'block';
        }

        // 隐藏结果
        function hideResult(resultId) {
            document.getElementById(resultId).style.display = 'none';
        }

        // 显示成功消息（底部toast弹窗）
        function showSuccess(title, message) {
            showToast(title, message, 'success');
        }

        // 显示错误消息（底部toast弹窗）
        function showError(title, message) {
            showToast(title, message, 'danger');
        }

        // 通用toast弹窗
        function showToast(title, message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type}`;
            toast.style = 'display: flex; justify-content: space-between; align-items: center; min-width: 320px; max-width: 90vw; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); pointer-events: auto; padding: 16px 24px; font-size: 1rem;';
            toast.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <strong style="font-size: 1.1em;">${title}</strong>
                    <span style="margin-top: 2px;">${message}</span>
                </div>
                <button type="button" class="btn-close btn-close-white ms-3" aria-label="关闭" style="pointer-events: auto;" onclick="this.parentNode.remove()"></button>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3500);
        }

        // 更新指标
        function updateMetrics(data) {
            if (data && data.length > 0) {
                document.getElementById('total-notes').textContent = data.length;
                
                // 计算平均点赞
                const likes = data.map(item => parseInt(item.likes) || 0);
                const avgLikes = likes.reduce((a, b) => a + b, 0) / likes.length;
                document.getElementById('avg-likes').textContent = Math.round(avgLikes);
            }
        }

        // 显示爬取数据
        function displayCrawlData(data) {
            currentData = data;
            updateMetrics(data);
            renderBlogList(data);
            showResult('crawlResult');
        }

        // 渲染博客列表
        function renderBlogList(data) {
            const blogList = document.getElementById('blogList');
            const blogCount = document.getElementById('blogCount');
            
            blogList.innerHTML = '';
            blogCount.textContent = data ? data.length : 0;
            
            if (!data || data.length === 0) {
                blogList.innerHTML = '<div class="text-center text-muted py-3">暂无数据</div>';
                return;
            }
            
            data.forEach((blog, index) => {
                const blogItem = document.createElement('div');
                blogItem.className = 'list-group-item blog-list-item';
                blogItem.onclick = () => selectBlog(index);
                
                blogItem.innerHTML = `
                    <div class="blog-title">${blog.title || '无标题'}</div>
                    <div class="blog-meta">
                        <i class="fas fa-user me-1"></i>${blog.author || '未知作者'}
                    </div>
                    <div class="blog-stats">
                        <div class="stat-item">
                            <i class="fas fa-heart text-danger"></i>
                            <span>${blog.likes || 0}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-star text-warning"></i>
                            <span>${blog.collects || 0}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-comment text-info"></i>
                            <span>${blog.comments || 0}</span>
                        </div>
                    </div>
                `;
                
                blogList.appendChild(blogItem);
            });
        }

        // 选择博客显示详情
        function selectBlog(index) {
            // 移除所有active类
            document.querySelectorAll('.blog-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加active类到选中的博客
            const selectedItem = document.querySelectorAll('.blog-list-item')[index];
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // 显示博客详情
            displayBlogDetail(currentData[index]);
        }

        // 显示博客详情
        function displayBlogDetail(blog) {
            const blogDetail = document.getElementById('blogDetail');
            const selectedBlogTitle = document.getElementById('selectedBlogTitle');
            
            selectedBlogTitle.textContent = blog.title || '无标题';
            
            blogDetail.innerHTML = `
                <div class="blog-detail-header">
                    <div class="blog-detail-title">${blog.title || '无标题'}</div>
                    <div class="blog-detail-author">
                        <i class="fas fa-user-circle fa-2x text-primary"></i>
                        <div>
                            <div class="fw-bold">${blog.author || '未知作者'}</div>
                            <small class="text-muted">${blog.publish_time || '发布时间未知'}</small>
                        </div>
                    </div>
                    <div class="blog-detail-stats">
                        <div class="stat-card">
                            <div class="stat-value">${blog.likes || 0}</div>
                            <div class="stat-label">点赞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${blog.collects || 0}</div>
                            <div class="stat-label">收藏</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${blog.comments || 0}</div>
                            <div class="stat-label">评论</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${blog.share || 0}</div>
                            <div class="stat-label">分享</div>
                        </div>
                    </div>
                </div>
                
                <div class="blog-detail-content">
                    <div class="blog-detail-section">
                        <h5><i class="fas fa-info-circle me-2"></i>基本信息</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>标题：</strong>${blog.title || '无标题'}</p>
                                <p><strong>作者：</strong>${blog.author || '未知作者'}</p>
                                <p><strong>发布时间：</strong>${blog.publish_time || '未知'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>链接：</strong>${blog.url ? `<a href="${blog.url}" target="_blank">查看原文</a>` : '无链接'}</p>
                                <p><strong>内容类型：</strong>${blog.content_type || '图文'}</p>
                                <p><strong>标签：</strong>${blog.tags ? blog.tags.join(', ') : '无标签'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="blog-detail-section">
                        <h5><i class="fas fa-chart-bar me-2"></i>数据分析</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>互动率分析</h6>
                                        <p>点赞率：${calculateEngagementRate(blog.likes, blog.views)}%</p>
                                        <p>收藏率：${calculateEngagementRate(blog.collects, blog.views)}%</p>
                                        <p>评论率：${calculateEngagementRate(blog.comments, blog.views)}%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>内容质量评估</h6>
                                        <p>综合评分：${calculateContentScore(blog)}/10</p>
                                        <p>热度等级：${getHeatLevel(blog.likes)}</p>
                                        <p>推荐指数：${getRecommendationLevel(blog)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${blog.description ? `
                    <div class="blog-detail-section">
                        <h5><i class="fas fa-align-left me-2"></i>内容摘要</h5>
                        <p>${blog.description}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // 计算互动率
        function calculateEngagementRate(interactions, views) {
            if (!views || views === 0) return 0;
            return ((interactions || 0) / views * 100).toFixed(2);
        }

        // 计算内容质量评分
        function calculateContentScore(blog) {
            let score = 5; // 基础分
            
            // 根据点赞数加分
            const likes = parseInt(blog.likes) || 0;
            if (likes > 1000) score += 2;
            else if (likes > 100) score += 1;
            
            // 根据收藏数加分
            const collects = parseInt(blog.collects) || 0;
            if (collects > 500) score += 2;
            else if (collects > 50) score += 1;
            
            // 根据评论数加分
            const comments = parseInt(blog.comments) || 0;
            if (comments > 100) score += 1;
            
            return Math.min(score, 10);
        }

        // 获取热度等级
        function getHeatLevel(likes) {
            const likeCount = parseInt(likes) || 0;
            if (likeCount > 10000) return '🔥 爆火';
            if (likeCount > 5000) return '🔥 热门';
            if (likeCount > 1000) return '🔥 较热';
            if (likeCount > 100) return '🔥 一般';
            return '🔥 冷门';
        }

        // 获取推荐指数
        function getRecommendationLevel(blog) {
            const score = calculateContentScore(blog);
            if (score >= 8) return '⭐⭐⭐⭐⭐ 强烈推荐';
            if (score >= 6) return '⭐⭐⭐⭐ 推荐';
            if (score >= 4) return '⭐⭐⭐ 一般';
            return '⭐⭐ 不推荐';
        }

        function renderCrawlTable() {
            const tbody = document.getElementById('crawlDataTableBody');
            if (!tbody) return; // 如果表格不存在，直接返回
            
            tbody.innerHTML = '';
            if (!currentData || currentData.length === 0) return;
            // 搜索过滤
            let filtered = currentData;
            if (tableState.search) {
                filtered = currentData.filter(item =>
                    (item.title && item.title.includes(tableState.search)) ||
                    (item.author && item.author.includes(tableState.search))
                );
            }
            // 分页
            const total = filtered.length;
            const pageSize = tableState.pageSize;
            const page = tableState.page;
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, total);
            const pageData = filtered.slice(start, end);
            // 渲染表格
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${start + index + 1}</td>
                    <td><div class="text-truncate" style="max-width: 200px;" title="${item.title || '无标题'}">${item.title || '无标题'}</div></td>
                    <td><div class="text-truncate" style="max-width: 120px;" title="${item.author || '未知作者'}">${item.author || '未知作者'}</div></td>
                    <td><span class="badge bg-success">${item.likes || 0}</span></td>
                    <td><span class="badge bg-info">${item.collects || 0}</span></td>
                    <td><span class="badge bg-warning">${item.comments || 0}</span></td>
                    <td><small class="text-muted">${item.publish_time || '未知'}</small></td>
                    <td>${item.url ? `<a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i></a>` : '<span class="text-muted">无链接</span>'}</td>
                `;
                tbody.appendChild(row);
            });
            // 分页信息
            const tablePageInfo = document.getElementById('tablePageInfo');
            if (tablePageInfo) {
                tablePageInfo.textContent = `共${total}条，${page}/${Math.ceil(total/pageSize)}页`;
            }
            // 渲染分页按钮
            renderTablePagination(Math.ceil(total/pageSize));
        }

        function renderTablePagination(totalPages) {
            const ul = document.getElementById('tablePagination');
            if (!ul) return; // 如果分页元素不存在，直接返回
            
            ul.innerHTML = '';
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === tableState.page ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.onclick = function(e) {
                    e.preventDefault();
                    tableState.page = i;
                    renderCrawlTable();
                };
                li.appendChild(a);
                ul.appendChild(li);
            }
        }

        // 显示分析结果
        function displayAnalysisResult(data) {
            const container = document.getElementById('analysisContent');
            
            if (data.ai_analysis) {
                container.innerHTML = `
                    <div class="analysis-text">
                        <h5><i class="fas fa-brain me-2"></i>AI分析结果</h5>
                        <div>${data.ai_analysis}</div>
                    </div>
                `;
            }
            
            if (data.trends) {
                const trendsHtml = `
                    <div class="mt-4">
                        <h5><i class="fas fa-chart-line me-2"></i>趋势分析</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>热门作者</h6>
                                <ul>
                                    ${data.trends.top_authors ? data.trends.top_authors.map(author => 
                                        `<li>${author.author} (${author.count}篇)</li>`
                                    ).join('') : '<li>暂无数据</li>'}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>热门话题</h6>
                                <ul>
                                    ${data.trends.popular_topics ? data.trends.popular_topics.map(topic => 
                                        `<li>${topic.keyword} (${topic.frequency}次)</li>`
                                    ).join('') : '<li>暂无数据</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += trendsHtml;
            }
        }

        // 初始化图表
        function initializeCharts() {
            // 作者分布图
            const authorCtx = document.getElementById('authorChart').getContext('2d');
            charts.authorChart = new Chart(authorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['暂无数据'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e9ecef']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '作者分布'
                        }
                    }
                }
            });

            // 点赞分布图
            const likesCtx = document.getElementById('likesChart').getContext('2d');
            charts.likesChart = new Chart(likesCtx, {
                type: 'bar',
                data: {
                    labels: ['暂无数据'],
                    datasets: [{
                        label: '点赞数',
                        data: [0],
                        backgroundColor: '#ff2442'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '点赞数分布'
                        }
                    }
                }
            });

            // 趋势图
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['暂无数据'],
                    datasets: [{
                        label: '趋势',
                        data: [0],
                        borderColor: '#ff2442',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '内容趋势'
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateCharts(data) {
            if (data.charts) {
                // 更新作者分布图
                if (data.charts.author_distribution) {
                    charts.authorChart.data.labels = data.charts.author_distribution.labels;
                    charts.authorChart.data.datasets[0].data = data.charts.author_distribution.data;
                    charts.authorChart.data.datasets[0].backgroundColor = generateColors(data.charts.author_distribution.labels.length);
                    charts.authorChart.update();
                }

                // 更新点赞分布图
                if (data.charts.likes_distribution) {
                    charts.likesChart.data.labels = data.charts.likes_distribution.labels;
                    charts.likesChart.data.datasets[0].data = data.charts.likes_distribution.data;
                    charts.likesChart.update();
                }
            }
        }

        // 生成颜色
        function generateColors(count) {
            const colors = [
                '#ff2442', '#ff6b81', '#ff8fa3', '#28a745', '#20c997',
                '#ffc107', '#fd7e14', '#6f42c1', '#e83e8c', '#6c757d'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // 导出表格为CSV
        function exportTableToCsv() {
            const table = document.getElementById('crawlDataTable');
            if (!table) {
                showError('导出失败', '未找到数据表格');
                return;
            }
            
            const rows = table.rows;
            const csv = [];

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.cells;
                const rowData = [];
                for (let j = 0; j < cells.length; j++) {
                    rowData.push(cells[j].textContent);
                }
                csv.push(rowData.join(','));
            }

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.href = url;
            link.download = '爬取数据.csv';
            link.click();

            URL.revokeObjectURL(url);
        }

        // 导出分析结果为JSON
        function exportAnalysisToJson() {
            const analysisContent = document.getElementById('analysisContent').innerHTML;
            const jsonContent = JSON.stringify({ analysis: analysisContent }, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.href = url;
            link.download = '分析结果.json';
            link.click();

            URL.revokeObjectURL(url);
        }

        // 下载图表
        function downloadCharts() {
            // 实现下载图表的逻辑
            console.log('下载图表');
        }
        
        // 切换标签页
        function switchToTab(tabName) {
            const tab = document.getElementById(tabName + '-tab');
            if (tab) {
                tab.click();
            }
        }
    </script>
</body>
</html> 